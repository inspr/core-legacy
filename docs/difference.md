# Inspr CLI Difference Output

This document is to further describe how the difference generated by the `insprctl apply` and `insprctl delete` operations work and what it describes to the user.

## What is it?

The difference is the reply given to the user when he decides to make a change in the current state of his cluster.

Look at this output example:
```
On: primesexample.primes.filter
Field                     | From       | To
Meta.Name                 |            | filter
Meta.Parent               |            | primesexample.primes
Spec.Node.Meta.Name       |            | filter
Spec.Node.Meta.Parent     |            | primesexample.primes
Spec.Node.Spec.Image      |            | gcr.io/insprlabs/inspr/examples/primes/filter:latest
Spec.Node.Spec.Replicas   | 0          | 2
Spec.Boundary.Input       | <nil>      | filterinput
Spec.Boundary.Output      | <nil>      | filteroutput
On: primesexample.primes.printer
Field                     | From       | To
Meta.Name                 |            | printer
Meta.Parent               |            | primesexample.primes
Spec.Node.Meta.Name       |            | printer
Spec.Node.Meta.Parent     |            | primesexample.primes
Spec.Node.Spec.Image      |            | gcr.io/insprlabs/inspr/examples/primes/printer:latest
Spec.Node.Spec.Replicas   | 0          | 1
Spec.Boundary.Input       | <nil>      | printerinput
```

The example shows only a section of the output given when we apply the `general.yaml` of the primes example. It informs the user that previously there was nothing in these dApps, meaning that they didn't exist, and that now all the fields given have changed values.

This feature is particularly useful when using the flag `--dry-run`, which means that your changes aren't directly affecting the Insprd structure in the cluster. This way the user has more control over what he is changing and can see the possible side effects of his changes.

## How is it formed

All requests for applying or deleting Insprd structures go through the diff operator. The diff operator analyzes the previous state of the Insprd structures and compares it with the new modified state generated by the user changes.  

For every structure and field that was altered, the diff operator stores the changes in a structure called `Change`. This structure identifies in which scope of Insprd's tree-like structure the modifications took place, as well as their kind (dApp, Channel, Type, Metadata, etc.), the operation (Delete, Update or Create) and the differences themselves:
```go
type Change struct {
	Scope     string       `json:"scope"`
	Diff      []Difference `json:"diff"`
	Kind      Kind
	Operation Operation
	changelog *Changelog
}
```

The field `Diff` in the `Change` struct is an array of a structure called `Difference`, which contains fields that provide a more specific description of the changes that took place:
```go
type Difference struct {
	Field     string `json:"field"`
	From      string `json:"from"`
	To        string `json:"to"`
	Kind      Kind
	Name      string
	Operation Operation
}
```

As multiple structures and fields can be altered at once in various scopes in Insprd, the diff operator actually stores all these changes in a structure called `Changelog`, which is basically an array of `Change`.

## How it works

Whenever the user runs `insprctl apply` or `insprctl delete` commands, the request handler gets the transaction changes for the whole tree structure using the diff operator. By doing so, all the changes made by the user to the previous state of
the Insprd tree-like structure are registered.  

Once that is done, the handler verifies if the user ran the command with the `--dry-run` flag. If so, it means that the identified changes should not be applyed, so the operation is cancelled and the changes that would've been done are printed on the user CLI.  

If it wasn't a dry run, the previous tree state is replaced by the new one that has the user's modifications, and the changes are printed on the user CLI. In this case, for every structure change there is a **reaction**, which are methods responsible for altering the cluster state so it adapts to the in-memory changes made by the user in Insprd.